<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pusula AI - retmen Asistan覺</title>
    <meta name="description" content="Yapay zeka destekli 繹retmen asistan覺">
    <meta name="theme-color" content="#6366f1">

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>妣</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            text-align: center;
            background: transparent;
            outline: none;
            font-weight: 500;
        }

        .cell-input:focus {
            background: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            border-radius: 4px;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .shadow-premium-blue {
            box-shadow: 0 10px 40px -10px rgba(37, 99, 235, 0.4);
        }

        .text-gradient-violet {
            background: linear-gradient(to right, #7c3aed, #db2777);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none z-50 shadow-sm relative text-slate-600">
        <div class="h-full px-4 sm:px-6 flex items-center gap-4">
            <!-- LEFT: Logo + Class Selector -->
            <div class="flex items-center gap-3 relative flex-shrink-0">
                <!-- Pusula AI Logo -->
                <div
                    class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-cyan-500 rounded-full flex items-center justify-center text-white shadow-sm flex-shrink-0 relative">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" />
                        <path d="M16.24 7.76L14.12 14.12L7.76 16.24L9.88 9.88L16.24 7.76Z" fill="white"
                            fill-opacity="0.9" />
                    </svg>
                    <div class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-yellow-300 rounded-full animate-pulse-glow">
                    </div>
                </div>

                <div class="hidden lg:block">
                    <h1 class="text-base font-black text-slate-800 tracking-tight">Pusula AI</h1>
                </div>

                <div class="h-8 w-px bg-slate-100 mx-1 hidden lg:block"></div>

                <!-- Class Selector -->
                <div class="relative">
                    <button id="classBtn" onclick="app.toggleClassMenu()"
                        class="flex flex-col items-start text-left hover:bg-slate-50 rounded px-2 py-1 transition-colors group">
                        <div class="flex items-center gap-2">
                            <span
                                class="text-sm font-bold text-slate-800 truncate leading-tight max-w-[150px] sm:max-w-xs"
                                id="activeClassName">Y羹kleniyor...</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-600 transition-transform"
                                id="classChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <span class="text-[10px] text-slate-400 font-medium whitespace-nowrap">S覺n覺f Se癟in</span>
                    </button>

                    <div id="classMenu"
                        class="hidden absolute top-12 left-0 w-64 bg-white border border-slate-200 rounded-xl shadow-xl z-50 p-1 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 bg-slate-50">
                            <span
                                class="text-xs font-bold text-slate-500 uppercase tracking-wider px-2">S覺n覺flar覺m</span>
                        </div>
                        <div id="classList" class="max-h-60 overflow-y-auto py-1 custom-scroll"></div>
                        <div class="p-2 border-t border-slate-100 bg-slate-50">
                            <button onclick="app.openModal('classModal', 'create')"
                                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-dashed border-blue-300 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-50 transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Yeni S覺n覺f Olutur
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete Class Button -->
                <button id="deleteClassBtn" onclick="app.confirmDeleteClass()"
                    class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    title="S覺n覺f覺 Sil">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- CENTER: Search -->
            <div class="hidden md:flex flex-1 justify-center">
                <div class="relative w-full max-w-md">
                    <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="renci ara..."
                        class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-medium"
                        oninput="app.handleSearch(this.value)">
                </div>
            </div>

            <!-- RIGHT: Actions -->
            <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                <!-- Auto-Save Indicator -->
                <div
                    class="hidden xl:flex items-center gap-1.5 px-2 py-1 rounded-md bg-slate-50 border border-slate-200">
                    <span class="text-[10px] font-bold uppercase text-slate-400" id="saveStatus">G羹ncel</span>
                </div>

                <!-- Dersler Button -->
                <button id="subjectsBtn" onclick="app.openModal('classModal', 'edit')"
                    class="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-200 text-slate-600 hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 rounded-lg text-sm font-bold transition-all shadow-sm group">
                    <svg class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                    <span class="hidden lg:inline">Dersler</span>
                </button>

                <!-- Analiz Button -->
                <button onclick="app.analyzeClass()"
                    class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-violet-50 to-fuchsia-50 text-violet-700 border border-violet-100 hover:from-violet-100 hover:to-fuchsia-100 rounded-lg text-sm font-bold transition-all shadow-sm group">
                    <svg class="w-4 h-4 group-hover:animate-pulse" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
                        </path>
                    </svg>
                    <span class="hidden lg:inline text-gradient-violet">Analiz</span>
                </button>

                <!-- Settings -->
                <button onclick="app.toggleSettingsMenu()"
                    class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>

                <div id="settingsMenu"
                    class="hidden absolute top-14 right-4 w-48 bg-white border border-slate-200 rounded-xl shadow-xl z-50 p-1">
                    <button onclick="app.openModal('classModal', 'edit')"
                        class="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                            </path>
                        </svg>
                        S覺n覺f覺 D羹zenle
                    </button>
                    <button onclick="app.importExcel()"
                        class="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Excel ile i癟eri aktar
                    </button>
                    <button onclick="app.exportExcel()"
                        class="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Excel ile d覺ar覺 aktar
                    </button>
                    <div class="h-px bg-slate-100 my-1"></div>
                    <button onclick="app.confirmDeleteClass()"
                        class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        S覺n覺f覺 Sil
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative flex flex-col bg-slate-50/50">
        <!-- Dashboard Cards -->
        <div class="px-6 py-6 grid grid-cols-2 md:grid-cols-4 gap-4 flex-none">
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-bold uppercase">renci</p>
                    <h3 class="text-xl font-bold text-slate-800" id="statStudents">0</h3>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Ders Say覺s覺</p>
                    <h3 class="text-xl font-bold text-slate-800" id="statSubjects">0</h3>
                </div>
            </div>

            <div
                class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 col-span-2 md:col-span-2">
                <div class="w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Veri Durumu</p>
                    <h3 class="text-xl font-bold text-emerald-600" id="statStatus">Tamamland覺</h3>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="px-6 pb-2 flex items-center justify-between flex-none">
            <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider">renci Listesi</h2>
            <button onclick="app.addStudent()"
                class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 hover:text-blue-600 hover:border-blue-200 rounded-lg text-sm font-medium transition-colors shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                renci Ekle
            </button>
        </div>

        <!-- Table Container -->
        <div class="flex-1 overflow-auto bg-white border-t border-slate-200 relative mx-6 mb-6 rounded-xl shadow-sm custom-scroll"
            id="tableContainer">
            <table class="w-full text-left text-sm border-collapse min-w-[800px]" id="mainTable">
                <thead class="bg-slate-50 text-slate-500 font-semibold sticky top-0 z-30">
                    <tr id="tableHeader">
                        <th class="w-10 px-4 py-3 text-center border-b border-slate-200 bg-slate-50 sticky left-0 z-40">
                            <input type="checkbox" id="selectAll" onchange="app.toggleSelectAll(this)"
                                class="rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        </th>
                        <th
                            class="w-10 px-2 py-3 text-center border-b border-slate-200 bg-slate-50 sticky left-10 z-40 font-bold text-slate-400 text-xs">
                            #</th>
                        <th class="px-4 py-3 border-b border-slate-200 bg-slate-50 sticky left-20 z-40 min-w-[200px] cursor-pointer hover:text-blue-600 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]"
                            onclick="app.sortBy('name')">
                            <div class="flex items-center gap-2">
                                renci Ad覺
                                <svg class="w-3.5 h-3.5 opacity-50" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <!-- Subject columns will be injected here -->
                        <th class="w-24 px-4 py-3 text-center border-b border-slate-200 bg-slate-50 cursor-pointer hover:text-blue-600"
                            onclick="app.sortBy('total')">
                            <div class="flex items-center justify-center gap-2">
                                Toplam
                                <svg class="w-3.5 h-3.5 opacity-50" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="w-24 px-4 py-3 border-b border-slate-200 bg-slate-50 text-center">襤lem</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100 text-slate-700"></tbody>
            </table>

            <!-- Empty State -->
            <div id="emptyState"
                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white z-10 p-6">
                <div
                    class="w-20 h-20 bg-slate-50/50 rounded-full flex items-center justify-center mb-6 text-slate-300 ring-8 ring-slate-50/20">
                    <svg class="w-9 h-9" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-[22px] font-bold text-slate-800 text-center max-w-sm px-6 mb-3 tracking-tight">
                    Balamak i癟in 繹ncelikle ders ekleyiniz.
                </h3>
                <p class="text-slate-400 text-base text-center max-w-xs mb-10 leading-relaxed">
                    renci eklemeden 繹nce not girii yapaca覺n覺z dersleri tan覺mlaman覺z gerekir.
                </p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="app.openModal('classModal', 'edit')"
                        class="px-8 py-4 bg-[#2563EB] text-white rounded-2xl text-base font-bold hover:bg-blue-700 shadow-premium-blue flex items-center gap-3 transition-all hover:scale-[1.02] active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                            </path>
                        </svg>
                        Ders Ekle
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- CLASS MODAL -->
    <div id="classModal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[90] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800" id="classModalTitle">S覺n覺f D羹zenle</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">S覺n覺f Ad覺</label>
                    <input type="text" id="classNameInput"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500"
                        placeholder="rn: 9-A">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Dersler</label>
                    <div id="subjectsList" class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-1"></div>
                    <button onclick="app.addSubjectRow()" class="mt-2 text-xs text-blue-600 font-bold hover:underline">+
                        Ders Ekle</button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="app.closeModal('classModal')"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium">襤ptal</button>
                <button onclick="app.saveClass()"
                    class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium shadow-sm">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const app = {
            state: {
                classes: [],
                activeClassId: null,
                searchQuery: '',
                sortKey: 'name',
                sortAsc: true,
                selectedIds: new Set(),
                modalMode: 'create'
            },

            init() {
                this.loadData();
                if (this.state.classes.length === 0) {
                    this.createClass('Genel S覺n覺f', []);
                }
                this.render();

                // Close dropdowns on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#classBtn') && !e.target.closest('#classMenu')) {
                        document.getElementById('classMenu').classList.add('hidden');
                    }
                    if (!e.target.closest('button[onclick*="toggleSettingsMenu"]') && !e.target.closest('#settingsMenu')) {
                        document.getElementById('settingsMenu').classList.add('hidden');
                    }
                });
            },

            loadData() {
                const data = localStorage.getItem('pusula_ai_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.state.classes = parsed.classes || [];
                    this.state.activeClassId = parsed.activeClassId || (this.state.classes[0]?.id);
                }
            },

            saveData() {
                localStorage.setItem('pusula_ai_data', JSON.stringify({
                    classes: this.state.classes,
                    activeClassId: this.state.activeClassId
                }));
                document.getElementById('saveStatus').textContent = 'Kaydedildi';
                setTimeout(() => {
                    document.getElementById('saveStatus').textContent = 'G羹ncel';
                }, 2000);
            },

            getActiveClass() {
                return this.state.classes.find(c => c.id === this.state.activeClassId);
            },

            createClass(name, subjects) {
                const newClass = {
                    id: 'cls_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    name: name,
                    subjects: subjects || [],
                    students: []
                };
                this.state.classes.push(newClass);
                this.state.activeClassId = newClass.id;
                this.saveData();
                this.render();
            },

            render() {
                const cls = this.getActiveClass();
                if (!cls) return;

                // Update header
                document.getElementById('activeClassName').textContent = cls.name;

                // Update stats
                document.getElementById('statStudents').textContent = cls.students.length;
                document.getElementById('statSubjects').textContent = cls.subjects.length;

                // Render class list
                const classList = document.getElementById('classList');
                classList.innerHTML = this.state.classes.map(c => `
                    <button onclick="app.switchClass('${c.id}')" class="w-full text-left px-3 py-2 text-sm rounded-lg transition-colors flex justify-between items-center ${c.id === this.state.activeClassId ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-50'}">
                        <span>${c.name}</span>
                        <span class="text-[10px] opacity-50 font-normal">${c.students.length} 繹r.</span>
                    </button>
                `).join('');

                // Render table
                this.renderTable();
            },

            renderTable() {
                const cls = this.getActiveClass();
                if (!cls) return;

                const tableHeader = document.getElementById('tableHeader');
                const tableBody = document.getElementById('tableBody');
                const emptyState = document.getElementById('emptyState');

                // Show empty state if no subjects
                if (cls.subjects.length === 0) {
                    emptyState.classList.remove('hidden');
                    document.getElementById('mainTable').classList.add('hidden');
                    return;
                } else {
                    emptyState.classList.add('hidden');
                    document.getElementById('mainTable').classList.remove('hidden');
                }

                // Build header with subject columns
                const subjectHeaders = cls.subjects.map(s => `
                    <th class="px-4 py-3 text-center border-b border-slate-200 bg-slate-50 font-semibold text-slate-600 whitespace-nowrap">
                        ${s.name}
                        <span class="block text-[9px] font-normal text-slate-400">(max ${s.max})</span>
                    </th>
                `).join('');

                // Insert subject headers before "Toplam" column
                const headerCells = tableHeader.querySelectorAll('th');
                const totalHeader = headerCells[headerCells.length - 2];
                totalHeader.insertAdjacentHTML('beforebegin', subjectHeaders);

                // Filter and sort students
                let students = [...cls.students];
                if (this.state.searchQuery) {
                    const q = this.state.searchQuery.toLowerCase();
                    students = students.filter(s => s.name.toLowerCase().includes(q));
                }

                students.sort((a, b) => {
                    const mult = this.state.sortAsc ? 1 : -1;
                    if (this.state.sortKey === 'name') {
                        return a.name.localeCompare(b.name, 'tr') * mult;
                    } else if (this.state.sortKey === 'total') {
                        const totalA = this.calcTotal(a, cls.subjects);
                        const totalB = this.calcTotal(b, cls.subjects);
                        return (totalA - totalB) * mult;
                    }
                    return 0;
                });

                // Render rows
                tableBody.innerHTML = students.map((student, idx) => {
                    const total = this.calcTotal(student, cls.subjects);
                    const isSelected = this.state.selectedIds.has(student.id);

                    const gradeCells = cls.subjects.map(sub => {
                        const grade = student.grades[sub.id];
                        return `
                            <td class="px-1 py-1 text-center h-12 p-0">
                                <input type="text" 
                                    class="cell-input text-sm ${grade !== undefined ? 'font-bold text-slate-800' : 'text-slate-300'}" 
                                    value="${grade !== undefined ? grade.toString().replace('.', ',') : ''}" 
                                    placeholder="-" 
                                    onfocus="this.select()" 
                                    onchange="app.updateGrade('${student.id}', '${sub.id}', this.value)">
                            </td>
                        `;
                    }).join('');

                    return `
                        <tr class="hover:bg-slate-50/80 transition-colors group ${isSelected ? 'bg-blue-50/50' : ''}">
                            <td class="w-10 px-4 py-3 text-center sticky left-0 z-20 ${isSelected ? 'bg-blue-50/50' : 'bg-white'}">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="app.toggleSelect('${student.id}', this.checked)" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            </td>
                            <td class="w-10 px-2 py-3 text-center sticky left-10 z-20 text-xs text-slate-400 font-medium ${isSelected ? 'bg-blue-50/50' : 'bg-white'}">${idx + 1}</td>
                            <td class="px-4 py-3 sticky left-20 z-20 font-medium text-slate-700 whitespace-nowrap min-w-[200px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] ${isSelected ? 'bg-blue-50/50' : 'bg-white'}">${student.name}</td>
                            ${gradeCells}
                            <td class="px-4 py-3 text-center font-bold text-slate-700 bg-slate-50/30">${total.toFixed(2).replace('.', ',')}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-1">
                                    <button onclick="app.analyzeStudent('${student.id}')" class="text-violet-400 hover:text-violet-600 p-2 rounded-lg hover:bg-violet-50 transition-colors" title="Analiz Et">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                                    </button>
                                    <button onclick="app.deleteStudent('${student.id}')" class="text-slate-300 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Sil">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            calcTotal(student, subjects) {
                let total = 0;
                subjects.forEach(sub => {
                    const grade = student.grades[sub.id];
                    if (grade !== undefined) total += grade;
                });
                return total;
            },

            updateGrade(studentId, subjectId, valueStr) {
                const cls = this.getActiveClass();
                const student = cls.students.find(s => s.id === studentId);
                if (!student) return;

                const val = valueStr.trim().replace(',', '.');
                if (val === '') {
                    delete student.grades[subjectId];
                } else {
                    const num = parseFloat(val);
                    if (!isNaN(num)) {
                        const subject = cls.subjects.find(s => s.id === subjectId);
                        student.grades[subjectId] = Math.max(0, Math.min(num, subject.max));
                    }
                }

                this.saveData();
                this.renderTable();
            },

            addStudent() {
                const name = prompt('renci Ad覺 Soyad覺:');
                if (!name || !name.trim()) return;

                const cls = this.getActiveClass();
                cls.students.push({
                    id: 'stu_' + Date.now(),
                    name: name.trim(),
                    grades: {}
                });

                this.saveData();
                this.render();
            },

            deleteStudent(id) {
                if (!confirm('renciyi silmek istediinize emin misiniz?')) return;

                const cls = this.getActiveClass();
                cls.students = cls.students.filter(s => s.id !== id);

                this.saveData();
                this.render();
            },

            toggleSelect(id, checked) {
                if (checked) {
                    this.state.selectedIds.add(id);
                } else {
                    this.state.selectedIds.delete(id);
                }
                this.renderTable();
            },

            toggleSelectAll(checkbox) {
                const cls = this.getActiveClass();
                if (checkbox.checked) {
                    cls.students.forEach(s => this.state.selectedIds.add(s.id));
                } else {
                    this.state.selectedIds.clear();
                }
                this.renderTable();
            },

            handleSearch(query) {
                this.state.searchQuery = query;
                this.renderTable();
            },

            sortBy(key) {
                if (this.state.sortKey === key) {
                    this.state.sortAsc = !this.state.sortAsc;
                } else {
                    this.state.sortKey = key;
                    this.state.sortAsc = true;
                }
                this.renderTable();
            },

            toggleClassMenu() {
                const menu = document.getElementById('classMenu');
                menu.classList.toggle('hidden');
            },

            toggleSettingsMenu() {
                const menu = document.getElementById('settingsMenu');
                menu.classList.toggle('hidden');
            },

            switchClass(id) {
                this.state.activeClassId = id;
                this.state.selectedIds.clear();
                this.state.searchQuery = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('classMenu').classList.add('hidden');
                this.saveData();
                this.render();
            },

            openModal(modalId, mode) {
                this.state.modalMode = mode;
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');

                if (modalId === 'classModal') {
                    const cls = this.getActiveClass();
                    document.getElementById('classModalTitle').textContent = mode === 'create' ? 'Yeni S覺n覺f' : 'S覺n覺f D羹zenle';
                    document.getElementById('classNameInput').value = mode === 'create' ? '' : cls.name;

                    const subjectsList = document.getElementById('subjectsList');
                    subjectsList.innerHTML = '';

                    if (mode === 'edit' && cls.subjects.length > 0) {
                        cls.subjects.forEach(sub => {
                            this.addSubjectRow(sub.name, sub.max);
                        });
                    }
                }

                document.getElementById('classMenu').classList.add('hidden');
                document.getElementById('settingsMenu').classList.add('hidden');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            },

            addSubjectRow(name = '', max = 100) {
                const subjectsList = document.getElementById('subjectsList');
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center mb-2';
                div.innerHTML = `
                    <input type="text" value="${name}" placeholder="Ders Ad覺" class="sub-name flex-1 px-2 py-1 border border-slate-300 rounded text-xs">
                    <input type="number" value="${max}" class="sub-max w-14 px-2 py-1 border border-slate-300 rounded text-xs text-center">
                    <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                subjectsList.appendChild(div);
            },

            saveClass() {
                const name = document.getElementById('classNameInput').value.trim();
                if (!name) return alert('S覺n覺f ad覺 giriniz.');

                const subjectDivs = document.querySelectorAll('#subjectsList > div');
                const subjects = [];
                subjectDivs.forEach(div => {
                    const sName = div.querySelector('.sub-name').value.trim();
                    const sMax = parseInt(div.querySelector('.sub-max').value) || 100;
                    if (sName) {
                        subjects.push({
                            id: sName.toLowerCase().substring(0, 3) + Math.floor(Math.random() * 1000),
                            name: sName.toUpperCase(),
                            max: sMax
                        });
                    }
                });

                if (subjects.length === 0) return alert('En az bir ders eklemelisiniz.');

                if (this.state.modalMode === 'create') {
                    this.createClass(name, subjects);
                } else {
                    const cls = this.getActiveClass();
                    cls.name = name;
                    cls.subjects = subjects;
                    this.saveData();
                    this.render();
                }

                this.closeModal('classModal');
            },

            confirmDeleteClass() {
                if (this.state.classes.length <= 1) return alert('En az bir s覺n覺f kalmal覺d覺r.');
                if (!confirm('S覺n覺f覺 silmek istediinize emin misiniz?')) return;

                this.state.classes = this.state.classes.filter(c => c.id !== this.state.activeClassId);
                this.state.activeClassId = this.state.classes[0].id;
                this.saveData();
                this.render();
                document.getElementById('settingsMenu').classList.add('hidden');
            },

            analyzeClass() {
                alert('S覺n覺f analizi 繹zellii yak覺nda eklenecek!');
            },

            analyzeStudent(id) {
                alert('renci analizi 繹zellii yak覺nda eklenecek!');
            },

            importExcel() {
                alert('Excel i癟e aktarma 繹zellii yak覺nda eklenecek!');
            },

            exportExcel() {
                const cls = this.getActiveClass();
                if (!cls || cls.students.length === 0) return alert('D覺a aktar覺lacak veri yok.');

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data
                const headers = ['renci Ad覺', ...cls.subjects.map(s => s.name), 'Toplam'];
                const rows = cls.students.map(student => {
                    const grades = cls.subjects.map(sub => student.grades[sub.id] ?? '');
                    const total = this.calcTotal(student, cls.subjects);
                    return [student.name, ...grades, total];
                });

                const wsData = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, cls.name);

                // Download
                XLSX.writeFile(wb, `${cls.name}_notlar.xlsx`);
            }
        };

        // Initialize app
        app.init();
    </script>
</body>

</html>